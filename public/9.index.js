(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{231:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),i=a(1),r=f(i),s=(f(a(11)),a(54)),o=a(122),l=a(269),u=f(a(84)),c=f(a(85)),d=a(249),h=f(a(87));function f(t){return t&&t.__esModule?t:{default:t}}a(86);var y=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,i.Component),n(e,[{key:"componentDidMount",value:function(){var t=this;document.title=u.default.getTitle()+" | Problem edit (SVG)",c.default.get(u.default.getUrl("problems?regionId="+u.default.getRegion()+"&id="+this.props.match.params.problemId)).withCredentials().end(function(e,a){if(e)t.setState({error:e});else{var n=a.body[0].media.filter(function(e){return e.id==t.props.match.params.mediaId})[0],i=[],r=0,s=[];if(n.svgs){var o=!0,l=!1,u=void 0;try{for(var c,d=n.svgs[Symbol.iterator]();!(o=(c=d.next()).done);o=!0){var h=c.value;h.problemId===a.body[0].id?(r=h.id,s=t.parsePath(h.path)):i.push({nr:h.nr,hasAnchor:h.hasAnchor,path:h.path})}}catch(e){l=!0,u=e}finally{try{!o&&d.return&&d.return()}finally{if(l)throw u}}}t.setState({mediaId:n.id,nr:a.body[0].nr,w:n.width,h:n.height,ctrl:!1,svgId:r,points:s,readOnlySvgs:i,activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!0,areaId:a.body[0].areaId,areaName:a.body[0].areaName,areaVisibility:a.body[0].areaVisibility,sectorId:a.body[0].sectorId,sectorName:a.body[0].sectorName,sectorVisibility:a.body[0].sectorVisibility,id:a.body[0].id,name:a.body[0].name,grade:a.body[0].grade,visibility:a.body[0].visibility})}}),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"handleKeyDown",value:function(t){t.ctrlKey&&this.setState({ctrl:!0})}},{key:"handleKeyUp",value:function(t){t.ctrlKey||this.setState({ctrl:!1})}},{key:"toggleAnchor",value:function(){this.setState({hasAnchor:!this.state.hasAnchor})}},{key:"onCancel",value:function(){window.history.back()}},{key:"save",value:function(t){var e=this;t.preventDefault(),c.default.post(u.default.getUrl("problems/svg?problemId="+this.state.id+"&mediaId="+this.state.mediaId)).withCredentials().send({delete:this.state.points.length<2,id:this.state.svgId,path:this.generatePath(),hasAnchor:this.state.hasAnchor}).end(function(t,a){t?e.setState({error:t}):e.setState({pushUrl:"/problem/"+e.state.id})})}},{key:"cancelDragging",value:function(t){this.setState({draggedPoint:!1,draggedCubic:!1})}},{key:"getMouseCoords",value:function(t){var e=this.refs["buldreinfo-svg-edit-img"].getBoundingClientRect(),a=this.state.w/e.width,n=this.state.h/e.height;return{x:Math.round((t.clientX-e.left)*a),y:Math.round((t.clientY-e.top)*n)}}},{key:"addPoint",value:function(t){if(this.state.ctrl){var e=this.getMouseCoords(t),a=this.state.points;a.push(e),this.setState({points:a,activePoint:a.length-1})}}},{key:"generatePath",value:function(){var t="";return this.state.points.forEach(function(e,a){0===a?t+="M ":e.q?t+="Q "+e.q.x+" "+e.q.y+" ":e.c?t+="C "+e.c[0].x+" "+e.c[0].y+" "+e.c[1].x+" "+e.c[1].y+" ":e.a?t+="A "+e.a.rx+" "+e.a.ry+" "+e.a.rot+" "+e.a.laf+" "+e.a.sf+" ":t+="L ",t+=e.x+" "+e.y+" "}),t}},{key:"handleMouseMove",value:function(t){return t.preventDefault(),this.state.ctrl||(this.state.draggedPoint?this.setPointCoords(this.getMouseCoords(t)):!1!==this.state.draggedCubic&&this.setCubicCoords(this.getMouseCoords(t),this.state.draggedCubic)),!1}},{key:"setPointCoords",value:function(t){var e=this.state.points,a=this.state.activePoint;e[a].x=t.x,e[a].y=t.y,this.setState({points:e})}},{key:"setCubicCoords",value:function(t,e){var a=this.state.points,n=this.state.activePoint;a[n].c[e].x=t.x,a[n].c[e].y=t.y,this.setState({points:a})}},{key:"setDraggedPoint",value:function(t){this.state.ctrl||this.setState({activePoint:t,draggedPoint:!0})}},{key:"setDraggedCubic",value:function(t,e){this.state.ctrl||this.setState({activePoint:t,draggedCubic:e})}},{key:"setPointType",value:function(t){var e=this.state.points,a=this.state.activePoint;if(0!==a){switch(t){case"L":e[a]={x:e[a].x,y:e[a].y};break;case"C":e[a]={x:e[a].x,y:e[a].y,c:[{x:(e[a].x+e[a-1].x-50)/2,y:(e[a].y+e[a-1].y)/2},{x:(e[a].x+e[a-1].x+50)/2,y:(e[a].y+e[a-1].y)/2}]}}this.setState({points:e})}}},{key:"removeActivePoint",value:function(t){var e=this.state.points,a=this.state.activePoint;e.length>1&&0!==a&&(e.splice(a,1),this.setState({points:e,activePoint:e.length-1}))}},{key:"reset",value:function(t){this.setState({ctrl:!1,points:[],activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!1})}},{key:"parseReadOnlySvgs",value:function(){var t=[],e=!0,a=!1,n=void 0;try{for(var i,s=this.state.readOnlySvgs[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var o=i.value;t.push(r.default.createElement("path",{key:t.length,d:o.path,className:"buldreinfo-svg-opacity buldreinfo-svg-route",strokeWidth:.003*this.state.w,strokeDasharray:.006*this.state.w}));var u=(0,l.parseSVG)(o.path);(0,l.makeAbsolute)(u),t.push(this.generateSvgNrAndAnchor(u,o.nr,o.hasAnchor))}}catch(t){a=!0,n=t}finally{try{!e&&s.return&&s.return()}finally{if(a)throw n}}return t}},{key:"generateSvgNrAndAnchor",value:function(t,e,a){for(var n,i,s=0,o=99999999,l=0,u=t.length;l<u;l++)t[l].y>s&&(n=l,s=t[l].y),t[l].y<o&&(i=l,o=t[l].y);var c=t[n].x,d=t[n].y,h=.012*this.state.w;c<h&&(c=h),c>this.state.w-h&&(c=this.state.w-h),d<h&&(d=h),d>this.state.h-h&&(d=this.state.h-h);var f=null;return a&&(f=r.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:t[i].x,cy:t[i].y,r:.006*this.state.w})),r.default.createElement("g",{className:"buldreinfo-svg-opacity"},r.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:c,cy:d,r:h}),r.default.createElement("text",{className:"buldreinfo-svg-routenr",x:c,y:d,fontSize:.02*this.state.w},e),f)}},{key:"parsePath",value:function(t){if(t){var e=(0,l.parseSVG)(t);return(0,l.makeAbsolute)(e),e.map(function(t){switch(t.code){case"L":case"M":return{x:Math.round(t.x),y:Math.round(t.y)};case"C":return{x:Math.round(t.x),y:Math.round(t.y),c:[{x:Math.round(t.x1),y:Math.round(t.y1)},{x:Math.round(t.x2),y:Math.round(t.y2)}]};case"S":return{x:Math.round(t.x),y:Math.round(t.y),c:[{x:Math.round(t.x0),y:Math.round(t.y0)},{x:Math.round(t.x2),y:Math.round(t.y2)}]}}})}return[]}},{key:"render",value:function(){var t=this;if(!this.state)return r.default.createElement("center",null,r.default.createElement(h.default,{icon:"spinner",spin:!0,size:"3x"}));if(this.state.error)return r.default.createElement("span",null,r.default.createElement("h3",null,this.state.error.status),this.state.error.toString());if(this.state.pushUrl)return r.default.createElement(d.Redirect,{to:this.state.pushUrl,push:!0});var e=this.state.points.map(function(e,a,n){var i=[];return e.c&&i.push(r.default.createElement("g",{className:"buldreinfo-svg-edit-opacity"},r.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:n[a-1].x,y1:n[a-1].y,x2:e.c[0].x,y2:e.c[0].y,strokeWidth:.0026*t.state.w,strokeDasharray:.003*t.state.w}),r.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:e.x,y1:e.y,x2:e.c[1].x,y2:e.c[1].y,strokeWidth:.0026*t.state.w,strokeDasharray:.003*t.state.w}),r.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.c[0].x,cy:e.c[0].y,r:.003*t.state.w,onMouseDown:t.setDraggedCubic.bind(t,a,0)}),r.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.c[1].x,cy:e.c[1].y,r:.003*t.state.w,onMouseDown:t.setDraggedCubic.bind(t,a,1)}))),r.default.createElement("g",{className:"buldreinfo-svg-ring-group"+(t.state.activePoint===a?"  is-active":"")},i,r.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.x,cy:e.y,r:.003*t.state.w,onMouseDown:t.setDraggedPoint.bind(t,a)}))}),a=this.generatePath();return r.default.createElement("span",null,r.default.createElement(o.Breadcrumb,null,r.default.createElement(s.Link,{to:"/"},"Home")," / ",r.default.createElement(s.Link,{to:"/browse"},"Browse")," / ",r.default.createElement(s.Link,{to:"/area/"+this.state.areaId},this.state.areaName)," ",1===this.state.areaVisibility&&r.default.createElement(h.default,{icon:"lock"}),2===this.state.areaVisibility&&r.default.createElement(h.default,{icon:"user-secret"})," / ",r.default.createElement(s.Link,{to:"/sector/"+this.state.sectorId},this.state.sectorName)," ",1===this.state.sectorVisibility&&r.default.createElement(h.default,{icon:"lock"}),2===this.state.sectorVisibility&&r.default.createElement(h.default,{icon:"user-secret"})," / ",r.default.createElement(s.Link,{to:"/problem/"+this.state.id},this.state.nr," ",this.state.name," ",this.state.grade)," ",1===this.state.visibility&&r.default.createElement(h.default,{icon:"lock"}),2===this.state.visibility&&r.default.createElement(h.default,{icon:"user-secret"})),r.default.createElement(o.Well,{bsSize:"small",onMouseUp:this.cancelDragging.bind(this),onMouseLeave:this.cancelDragging.bind(this)},r.default.createElement("form",{onSubmit:this.save.bind(this)},r.default.createElement(o.FormGroup,{controlId:"formControlsInfo"},r.default.createElement(o.Alert,{bsStyle:"info"},r.default.createElement("center",null,r.default.createElement("strong",null,"CTRL + CLICK")," to add a point | ",r.default.createElement("strong",null,"CLICK")," to select a point | ",r.default.createElement("strong",null,"CLICK AND DRAG")," to move a point",r.default.createElement("br",null),r.default.createElement(o.ButtonGroup,null,0!==this.state.activePoint&&r.default.createElement(o.DropdownButton,{title:this.state.points[this.state.activePoint].c?"Selected point: Curve to":"Selected point: Line to",id:"bg-nested-dropdown"},r.default.createElement(o.MenuItem,{eventKey:"0",onSelect:this.setPointType.bind(this,"L")},"Selected point: Line to"),r.default.createElement(o.MenuItem,{eventKey:"1",onSelect:this.setPointType.bind(this,"C")},"Selected point: Curve to")),0!==this.state.activePoint&&r.default.createElement(o.Button,{onClick:this.removeActivePoint.bind(this)},"Remove this point"),r.default.createElement(o.DropdownButton,{title:this.state.hasAnchor?"Route has anchor":"No anchor on route",disabled:0===this.state.points.length,id:"bg-nested-dropdown"},r.default.createElement(o.MenuItem,{eventKey:"0",onSelect:this.toggleAnchor.bind(this)},"No anchor on route"),r.default.createElement(o.MenuItem,{eventKey:"1",onSelect:this.toggleAnchor.bind(this)},"Route has anchor")),r.default.createElement(o.Button,{bsStyle:"warning",disabled:0===this.state.points.length,onClick:this.reset.bind(this)},"Reset path"),r.default.createElement(o.Button,{bsStyle:"danger",onClick:this.onCancel.bind(this)},"Cancel"),r.default.createElement(o.Button,{type:"submit",bsStyle:"success"},this.state.points.length>=2?"Save":"Delete path"))))),r.default.createElement(o.FormGroup,{controlId:"formControlsImage"},r.default.createElement("svg",{viewBox:"0 0 "+this.state.w+" "+this.state.h,onClick:this.addPoint.bind(this),onMouseMove:this.handleMouseMove.bind(this)},r.default.createElement("image",{ref:"buldreinfo-svg-edit-img",xlinkHref:u.default.getUrl("images?id="+this.state.mediaId),width:"100%",height:"100%"}),this.parseReadOnlySvgs(),r.default.createElement("path",{className:"buldreinfo-svg-route",d:a,strokeWidth:.002*this.state.w}),e)),r.default.createElement(o.FormGroup,{controlId:"formControlsPath"},a))))}}]),e}();e.default=y},249:function(t,e,a){"use strict";a.r(e);var n=a(93);a.d(e,"MemoryRouter",function(){return n.a});var i=a(92);a.d(e,"Prompt",function(){return i.a});var r=a(88);a.d(e,"Redirect",function(){return r.a});var s=a(46);a.d(e,"Route",function(){return s.a});var o=a(31);a.d(e,"Router",function(){return o.a});var l=a(91);a.d(e,"StaticRouter",function(){return l.a});var u=a(90);a.d(e,"Switch",function(){return u.a});var c=a(30);a.d(e,"matchPath",function(){return c.a});var d=a(89);a.d(e,"withRouter",function(){return d.a})}}]);
//# sourceMappingURL=9.index.js.map
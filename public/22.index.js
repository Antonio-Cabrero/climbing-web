(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{676:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=n(1),s=f(i),r=(f(n(15)),n(141)),o=n(282),l=n(726),c=f(n(200)),u=f(n(201)),d=n(284),h=n(142);function f(e){return e&&e.__esModule?e:{default:e}}var y=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.Component),a(t,[{key:"componentDidMount",value:function(){var e=this;u.default.get(c.default.getUrl("problems?regionId="+c.default.getRegion()+"&id="+this.props.match.params.problemId)).withCredentials().end(function(t,n){if(t)e.setState({error:t});else{var a=n.body[0].media.filter(function(t){return t.id==e.props.match.params.mediaId})[0],i=[],s=0,r=[];if(a.svgs){var o=!0,l=!1,c=void 0;try{for(var u,d=a.svgs[Symbol.iterator]();!(o=(u=d.next()).done);o=!0){var h=u.value;h.problemId===n.body[0].id?(s=h.id,r=e.parsePath(h.path)):i.push({nr:h.nr,hasAnchor:h.hasAnchor,path:h.path})}}catch(t){l=!0,c=t}finally{try{!o&&d.return&&d.return()}finally{if(l)throw c}}}e.setState({mediaId:a.id,nr:n.body[0].nr,w:a.width,h:a.height,ctrl:!1,svgId:s,points:r,readOnlySvgs:i,activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!0,areaId:n.body[0].areaId,areaName:n.body[0].areaName,areaVisibility:n.body[0].areaVisibility,sectorId:n.body[0].sectorId,sectorName:n.body[0].sectorName,sectorVisibility:n.body[0].sectorVisibility,id:n.body[0].id,name:n.body[0].name,grade:n.body[0].grade,visibility:n.body[0].visibility})}}),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"handleKeyDown",value:function(e){e.ctrlKey&&this.setState({ctrl:!0})}},{key:"handleKeyUp",value:function(e){e.ctrlKey||this.setState({ctrl:!1})}},{key:"setHasAnchor",value:function(e){this.setState({hasAnchor:e})}},{key:"onCancel",value:function(){window.history.back()}},{key:"save",value:function(e){var t=this;e.preventDefault(),u.default.post(c.default.getUrl("problems/svg?problemId="+this.state.id+"&mediaId="+this.state.mediaId)).withCredentials().send({delete:this.state.points.length<2,id:this.state.svgId,path:this.generatePath(),hasAnchor:this.state.hasAnchor}).end(function(e,n){e?t.setState({error:e}):t.setState({pushUrl:"/problem/"+t.state.id})})}},{key:"cancelDragging",value:function(e){this.setState({draggedPoint:!1,draggedCubic:!1})}},{key:"getMouseCoords",value:function(e){var t=this.refs["buldreinfo-svg-edit-img"].getBoundingClientRect(),n=this.state.w/t.width,a=this.state.h/t.height;return{x:Math.round((e.clientX-t.left)*n),y:Math.round((e.clientY-t.top)*a)}}},{key:"addPoint",value:function(e){if(this.state.ctrl){var t=this.getMouseCoords(e),n=this.state.points;n.push(t),this.setState({points:n,activePoint:n.length-1})}}},{key:"generatePath",value:function(){var e="";return this.state.points.forEach(function(t,n){0===n?e+="M ":t.q?e+="Q "+t.q.x+" "+t.q.y+" ":t.c?e+="C "+t.c[0].x+" "+t.c[0].y+" "+t.c[1].x+" "+t.c[1].y+" ":t.a?e+="A "+t.a.rx+" "+t.a.ry+" "+t.a.rot+" "+t.a.laf+" "+t.a.sf+" ":e+="L ",e+=t.x+" "+t.y+" "}),e}},{key:"handleMouseMove",value:function(e){return e.preventDefault(),this.state.ctrl||(this.state.draggedPoint?this.setPointCoords(this.getMouseCoords(e)):!1!==this.state.draggedCubic&&this.setCubicCoords(this.getMouseCoords(e),this.state.draggedCubic)),!1}},{key:"setPointCoords",value:function(e){var t=this.state.points,n=this.state.activePoint;t[n].x=e.x,t[n].y=e.y,this.setState({points:t})}},{key:"setCubicCoords",value:function(e,t){var n=this.state.points,a=this.state.activePoint;n[a].c[t].x=e.x,n[a].c[t].y=e.y,this.setState({points:n})}},{key:"setDraggedPoint",value:function(e){this.state.ctrl||this.setState({activePoint:e,draggedPoint:!0})}},{key:"setDraggedCubic",value:function(e,t){this.state.ctrl||this.setState({activePoint:e,draggedCubic:t})}},{key:"setPointType",value:function(e){var t=this.state.points,n=this.state.activePoint;if(0!==n){switch(e){case"L":t[n]={x:t[n].x,y:t[n].y};break;case"C":t[n]={x:t[n].x,y:t[n].y,c:[{x:(t[n].x+t[n-1].x-50)/2,y:(t[n].y+t[n-1].y)/2},{x:(t[n].x+t[n-1].x+50)/2,y:(t[n].y+t[n-1].y)/2}]}}this.setState({points:t})}}},{key:"removeActivePoint",value:function(e){var t=this.state.points,n=this.state.activePoint;t.length>1&&0!==n&&(t.splice(n,1),this.setState({points:t,activePoint:t.length-1}))}},{key:"reset",value:function(e){this.setState({ctrl:!1,points:[],activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!1})}},{key:"parseReadOnlySvgs",value:function(){var e=[],t=!0,n=!1,a=void 0;try{for(var i,r=this.state.readOnlySvgs[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var o=i.value;e.push(s.default.createElement("path",{key:e.length,d:o.path,className:"buldreinfo-svg-opacity buldreinfo-svg-route",strokeWidth:.003*this.state.w,strokeDasharray:.006*this.state.w}));var c=(0,l.parseSVG)(o.path);(0,l.makeAbsolute)(c),e.push(this.generateSvgNrAndAnchor(c,o.nr,o.hasAnchor))}}catch(e){n=!0,a=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw a}}return e}},{key:"generateSvgNrAndAnchor",value:function(e,t,n){for(var a,i,r=0,o=99999999,l=0,c=e.length;l<c;l++)e[l].y>r&&(a=l,r=e[l].y),e[l].y<o&&(i=l,o=e[l].y);var u=e[a].x,d=e[a].y,h=.012*this.state.w;u<h&&(u=h),u>this.state.w-h&&(u=this.state.w-h),d<h&&(d=h),d>this.state.h-h&&(d=this.state.h-h);var f=null;return!0===n&&(f=s.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:e[i].x,cy:e[i].y,r:.006*this.state.w})),s.default.createElement("g",{className:"buldreinfo-svg-opacity"},s.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:u,cy:d,r:h}),s.default.createElement("text",{className:"buldreinfo-svg-routenr",x:u,y:d,fontSize:.02*this.state.w},t),f)}},{key:"parsePath",value:function(e){if(e){var t=(0,l.parseSVG)(e);return(0,l.makeAbsolute)(t),t.map(function(e){switch(e.code){case"L":case"M":return{x:Math.round(e.x),y:Math.round(e.y)};case"C":return{x:Math.round(e.x),y:Math.round(e.y),c:[{x:Math.round(e.x1),y:Math.round(e.y1)},{x:Math.round(e.x2),y:Math.round(e.y2)}]};case"S":return{x:Math.round(e.x),y:Math.round(e.y),c:[{x:Math.round(e.x0),y:Math.round(e.y0)},{x:Math.round(e.x2),y:Math.round(e.y2)}]}}})}return[]}},{key:"render",value:function(){var e=this;if(!this.state)return s.default.createElement("center",null,s.default.createElement(h.FontAwesomeIcon,{icon:"spinner",spin:!0,size:"3x"}));if(this.state.error)return s.default.createElement("span",null,s.default.createElement("h3",null,this.state.error.status),this.state.error.toString());if(this.state.pushUrl)return s.default.createElement(d.Redirect,{to:this.state.pushUrl,push:!0});var t=this.state.points.map(function(t,n,a){var i=[];return t.c&&i.push(s.default.createElement("g",{className:"buldreinfo-svg-edit-opacity"},s.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:a[n-1].x,y1:a[n-1].y,x2:t.c[0].x,y2:t.c[0].y,strokeWidth:.0026*e.state.w,strokeDasharray:.003*e.state.w}),s.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:t.x,y1:t.y,x2:t.c[1].x,y2:t.c[1].y,strokeWidth:.0026*e.state.w,strokeDasharray:.003*e.state.w}),s.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:t.c[0].x,cy:t.c[0].y,r:.003*e.state.w,onMouseDown:e.setDraggedCubic.bind(e,n,0)}),s.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:t.c[1].x,cy:t.c[1].y,r:.003*e.state.w,onMouseDown:e.setDraggedCubic.bind(e,n,1)}))),s.default.createElement("g",{className:"buldreinfo-svg-ring-group"+(e.state.activePoint===n?"  is-active":"")},i,s.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:t.x,cy:t.y,r:.003*e.state.w,onMouseDown:e.setDraggedPoint.bind(e,n)}))}),n=this.generatePath();return s.default.createElement("span",null,s.default.createElement(o.Breadcrumb,null,s.default.createElement(r.Link,{to:"/"},"Home")," / ",s.default.createElement(r.Link,{to:"/browse"},"Browse")," / ",s.default.createElement(r.Link,{to:"/area/"+this.state.areaId},this.state.areaName)," ",1===this.state.areaVisibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"lock"}),2===this.state.areaVisibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"user-secret"})," / ",s.default.createElement(r.Link,{to:"/sector/"+this.state.sectorId},this.state.sectorName)," ",1===this.state.sectorVisibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"lock"}),2===this.state.sectorVisibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"user-secret"})," / ",s.default.createElement(r.Link,{to:"/problem/"+this.state.id},this.state.nr," ",this.state.name," ",this.state.grade)," ",1===this.state.visibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"lock"}),2===this.state.visibility&&s.default.createElement(h.FontAwesomeIcon,{icon:"user-secret"})),s.default.createElement(o.Well,{bsSize:"small",onMouseUp:this.cancelDragging.bind(this),onMouseLeave:this.cancelDragging.bind(this)},s.default.createElement("form",{onSubmit:this.save.bind(this)},s.default.createElement(o.FormGroup,{controlId:"formControlsInfo"},s.default.createElement(o.Alert,{bsStyle:"info"},s.default.createElement("center",null,s.default.createElement("strong",null,"CTRL + CLICK")," to add a point | ",s.default.createElement("strong",null,"CLICK")," to select a point | ",s.default.createElement("strong",null,"CLICK AND DRAG")," to move a point",s.default.createElement("br",null),s.default.createElement(o.ButtonGroup,null,0!==this.state.activePoint&&s.default.createElement(o.DropdownButton,{title:this.state.points[this.state.activePoint].c?"Selected point: Curve to":"Selected point: Line to",id:"bg-nested-dropdown"},s.default.createElement(o.MenuItem,{eventKey:"0",onSelect:this.setPointType.bind(this,"L")},"Selected point: Line to"),s.default.createElement(o.MenuItem,{eventKey:"1",onSelect:this.setPointType.bind(this,"C")},"Selected point: Curve to")),0!==this.state.activePoint&&s.default.createElement(o.Button,{onClick:this.removeActivePoint.bind(this)},"Remove this point"),s.default.createElement(o.DropdownButton,{title:!0===this.state.hasAnchor?"Route has anchor":"No anchor on route",disabled:0===this.state.points.length,id:"bg-nested-dropdown"},s.default.createElement(o.MenuItem,{eventKey:"0",onSelect:this.setHasAnchor.bind(this,!1)},"No anchor on route"),s.default.createElement(o.MenuItem,{eventKey:"1",onSelect:this.setHasAnchor.bind(this,!0)},"Route has anchor")),s.default.createElement(o.Button,{bsStyle:"warning",disabled:0===this.state.points.length,onClick:this.reset.bind(this)},"Reset path"),s.default.createElement(o.Button,{bsStyle:"danger",onClick:this.onCancel.bind(this)},"Cancel"),s.default.createElement(o.Button,{type:"submit",bsStyle:"success"},this.state.points.length>=2?"Save":"Delete path"))))),s.default.createElement(o.FormGroup,{controlId:"formControlsImage"},s.default.createElement("svg",{viewBox:"0 0 "+this.state.w+" "+this.state.h,onClick:this.addPoint.bind(this),onMouseMove:this.handleMouseMove.bind(this)},s.default.createElement("image",{ref:"buldreinfo-svg-edit-img",xlinkHref:c.default.getUrl("images?id="+this.state.mediaId),width:"100%",height:"100%"}),this.parseReadOnlySvgs(),s.default.createElement("path",{className:"buldreinfo-svg-route",d:n,strokeWidth:.002*this.state.w}),t)),s.default.createElement(o.FormGroup,{controlId:"formControlsPath"},n))))}}]),t}();t.default=y}}]);
//# sourceMappingURL=22.index.js.map
(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{55:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}(),r=n(1),i=f(r),o=(f(n(14)),n(15)),s=n(84),l=n(163),u=f(n(79)),d=f(n(81)),c=n(91),h=f(n(30));function f(t){return t&&t.__esModule?t:{default:t}}n(29);var g=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,r.Component),a(e,[{key:"componentDidMount",value:function(){var t=this;document.title=u.default.getTitle()+" | Problem edit (SVG)",d.default.get(u.default.getUrl("problems?regionId="+u.default.getRegion()+"&id="+this.props.match.params.problemId)).withCredentials().end(function(e,n){if(e)t.setState({error:e});else{var a=n.body[0].media.filter(function(e){return e.id==t.props.match.params.mediaId})[0],r=[],i=0,o=[];if(a.svgs){var s=!0,l=!1,u=void 0;try{for(var d,c=a.svgs[Symbol.iterator]();!(s=(d=c.next()).done);s=!0){var h=d.value;h.problemId===n.body[0].id?(i=h.id,o=t.parsePath(h.path)):r.push({nr:h.nr,hasAnchor:h.hasAnchor,path:h.path})}}catch(e){l=!0,u=e}finally{try{!s&&c.return&&c.return()}finally{if(l)throw u}}}t.setState({mediaId:a.id,nr:n.body[0].nr,w:a.width,h:a.height,ctrl:!1,svgId:i,points:o,readOnlySvgs:r,activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!0,areaId:n.body[0].areaId,areaName:n.body[0].areaName,areaVisibility:n.body[0].areaVisibility,sectorId:n.body[0].sectorId,sectorName:n.body[0].sectorName,sectorVisibility:n.body[0].sectorVisibility,id:n.body[0].id,name:n.body[0].name,grade:n.body[0].grade,visibility:n.body[0].visibility})}}),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}},{key:"handleKeyDown",value:function(t){t.ctrlKey&&this.setState({ctrl:!0})}},{key:"handleKeyUp",value:function(t){t.ctrlKey||this.setState({ctrl:!1})}},{key:"toggleAnchor",value:function(){this.setState({hasAnchor:!this.state.hasAnchor})}},{key:"onCancel",value:function(){window.history.back()}},{key:"save",value:function(t){var e=this;t.preventDefault(),d.default.post(u.default.getUrl("problems/svg?problemId="+this.state.id+"&mediaId="+this.state.mediaId)).withCredentials().send({delete:this.state.points.length<2,id:this.state.svgId,path:this.generatePath(),hasAnchor:this.state.hasAnchor}).end(function(t,n){t?e.setState({error:t}):e.setState({pushUrl:"/problem/"+e.state.id})})}},{key:"cancelDragging",value:function(t){this.setState({draggedPoint:!1,draggedCubic:!1})}},{key:"getMouseCoords",value:function(t){var e=this.refs["buldreinfo-svg-edit-img"].getBoundingClientRect(),n=this.state.w/e.width,a=this.state.h/e.height;return{x:Math.round((t.clientX-e.left)*n),y:Math.round((t.clientY-e.top)*a)}}},{key:"addPoint",value:function(t){if(this.state.ctrl){var e=this.getMouseCoords(t),n=this.state.points;n.push(e),this.setState({points:n,activePoint:n.length-1})}}},{key:"generatePath",value:function(){var t="";return this.state.points.forEach(function(e,n){0===n?t+="M ":e.q?t+="Q "+e.q.x+" "+e.q.y+" ":e.c?t+="C "+e.c[0].x+" "+e.c[0].y+" "+e.c[1].x+" "+e.c[1].y+" ":e.a?t+="A "+e.a.rx+" "+e.a.ry+" "+e.a.rot+" "+e.a.laf+" "+e.a.sf+" ":t+="L ",t+=e.x+" "+e.y+" "}),t}},{key:"handleMouseMove",value:function(t){return t.preventDefault(),this.state.ctrl||(this.state.draggedPoint?this.setPointCoords(this.getMouseCoords(t)):!1!==this.state.draggedCubic&&this.setCubicCoords(this.getMouseCoords(t),this.state.draggedCubic)),!1}},{key:"setPointCoords",value:function(t){var e=this.state.points,n=this.state.activePoint;e[n].x=t.x,e[n].y=t.y,this.setState({points:e})}},{key:"setCubicCoords",value:function(t,e){var n=this.state.points,a=this.state.activePoint;n[a].c[e].x=t.x,n[a].c[e].y=t.y,this.setState({points:n})}},{key:"setDraggedPoint",value:function(t){this.state.ctrl||this.setState({activePoint:t,draggedPoint:!0})}},{key:"setDraggedCubic",value:function(t,e){this.state.ctrl||this.setState({activePoint:t,draggedCubic:e})}},{key:"setPointType",value:function(t){var e=this.state.points,n=this.state.activePoint;if(0!==n){switch(t){case"L":e[n]={x:e[n].x,y:e[n].y};break;case"C":e[n]={x:e[n].x,y:e[n].y,c:[{x:(e[n].x+e[n-1].x-50)/2,y:(e[n].y+e[n-1].y)/2},{x:(e[n].x+e[n-1].x+50)/2,y:(e[n].y+e[n-1].y)/2}]}}this.setState({points:e})}}},{key:"removeActivePoint",value:function(t){var e=this.state.points,n=this.state.activePoint;e.length>1&&0!==n&&(e.splice(n,1),this.setState({points:e,activePoint:e.length-1}))}},{key:"reset",value:function(t){this.setState({ctrl:!1,points:[],activePoint:0,draggedPoint:!1,draggedCubic:!1,hasAnchor:!1})}},{key:"parseReadOnlySvgs",value:function(){var t=[],e=!0,n=!1,a=void 0;try{for(var r,o=this.state.readOnlySvgs[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value;t.push(i.default.createElement("path",{key:t.length,d:s.path,className:"buldreinfo-svg-opacity buldreinfo-svg-route",strokeWidth:.003*this.state.w,strokeDasharray:.006*this.state.w}));var u=(0,l.parseSVG)(s.path);(0,l.makeAbsolute)(u),t.push(this.generateSvgNrAndAnchor(u,s.nr,s.hasAnchor))}}catch(t){n=!0,a=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw a}}return t}},{key:"generateSvgNrAndAnchor",value:function(t,e,n){for(var a,r,o=0,s=99999999,l=0,u=t.length;l<u;l++)t[l].y>o&&(a=l,o=t[l].y),t[l].y<s&&(r=l,s=t[l].y);var d=t[a].x,c=t[a].y,h=.012*this.state.w;d<h&&(d=h),d>this.state.w-h&&(d=this.state.w-h),c<h&&(c=h),c>this.state.h-h&&(c=this.state.h-h);var f=null;return n&&(f=i.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:t[r].x,cy:t[r].y,r:.006*this.state.w})),i.default.createElement("g",{className:"buldreinfo-svg-opacity"},i.default.createElement("circle",{className:"buldreinfo-svg-ring",cx:d,cy:c,r:h}),i.default.createElement("text",{className:"buldreinfo-svg-routenr",x:d,y:c,fontSize:.02*this.state.w},e),f)}},{key:"parsePath",value:function(t){if(t){var e=(0,l.parseSVG)(t);return(0,l.makeAbsolute)(e),e.map(function(t){switch(t.code){case"L":case"M":return{x:Math.round(t.x),y:Math.round(t.y)};case"C":return{x:Math.round(t.x),y:Math.round(t.y),c:[{x:Math.round(t.x1),y:Math.round(t.y1)},{x:Math.round(t.x2),y:Math.round(t.y2)}]};case"S":return{x:Math.round(t.x),y:Math.round(t.y),c:[{x:Math.round(t.x0),y:Math.round(t.y0)},{x:Math.round(t.x2),y:Math.round(t.y2)}]}}})}return[]}},{key:"render",value:function(){var t=this;if(!this.state)return i.default.createElement("center",null,i.default.createElement(h.default,{icon:"spinner",spin:!0,size:"3x"}));if(this.state.error)return i.default.createElement("span",null,i.default.createElement("h3",null,this.state.error.status),this.state.error.toString());if(this.state.pushUrl)return i.default.createElement(c.Redirect,{to:this.state.pushUrl,push:!0});var e=this.state.points.map(function(e,n,a){var r=[];return e.c&&r.push(i.default.createElement("g",{className:"buldreinfo-svg-edit-opacity"},i.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:a[n-1].x,y1:a[n-1].y,x2:e.c[0].x,y2:e.c[0].y,strokeWidth:.0026*t.state.w,strokeDasharray:.003*t.state.w}),i.default.createElement("line",{className:"buldreinfo-svg-pointer buldreinfo-svg-route",x1:e.x,y1:e.y,x2:e.c[1].x,y2:e.c[1].y,strokeWidth:.0026*t.state.w,strokeDasharray:.003*t.state.w}),i.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.c[0].x,cy:e.c[0].y,r:.003*t.state.w,onMouseDown:t.setDraggedCubic.bind(t,n,0)}),i.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.c[1].x,cy:e.c[1].y,r:.003*t.state.w,onMouseDown:t.setDraggedCubic.bind(t,n,1)}))),i.default.createElement("g",{className:"buldreinfo-svg-ring-group"+(t.state.activePoint===n?"  is-active":"")},r,i.default.createElement("circle",{className:"buldreinfo-svg-pointer buldreinfo-svg-ring",cx:e.x,cy:e.y,r:.003*t.state.w,onMouseDown:t.setDraggedPoint.bind(t,n)}))}),n=this.generatePath();return i.default.createElement("span",null,i.default.createElement(s.Breadcrumb,null,i.default.createElement(o.Link,{to:"/"},"Home")," / ",i.default.createElement(o.Link,{to:"/browse"},"Browse")," / ",i.default.createElement(o.Link,{to:"/area/"+this.state.areaId},this.state.areaName)," ",1===this.state.areaVisibility&&i.default.createElement(h.default,{icon:"lock"}),2===this.state.areaVisibility&&i.default.createElement(h.default,{icon:"user-secret"})," / ",i.default.createElement(o.Link,{to:"/sector/"+this.state.sectorId},this.state.sectorName)," ",1===this.state.sectorVisibility&&i.default.createElement(h.default,{icon:"lock"}),2===this.state.sectorVisibility&&i.default.createElement(h.default,{icon:"user-secret"})," / ",i.default.createElement(o.Link,{to:"/problem/"+this.state.id},this.state.nr," ",this.state.name," ",this.state.grade)," ",1===this.state.visibility&&i.default.createElement(h.default,{icon:"lock"}),2===this.state.visibility&&i.default.createElement(h.default,{icon:"user-secret"})),i.default.createElement(s.Well,{bsSize:"small",onMouseUp:this.cancelDragging.bind(this),onMouseLeave:this.cancelDragging.bind(this)},i.default.createElement("form",{onSubmit:this.save.bind(this)},i.default.createElement(s.FormGroup,{controlId:"formControlsInfo"},i.default.createElement(s.Alert,{bsStyle:"info"},i.default.createElement("center",null,i.default.createElement("strong",null,"CTRL + CLICK")," to add a point | ",i.default.createElement("strong",null,"CLICK")," to select a point | ",i.default.createElement("strong",null,"CLICK AND DRAG")," to move a point",i.default.createElement("br",null),i.default.createElement(s.ButtonGroup,null,0!==this.state.activePoint&&i.default.createElement(s.DropdownButton,{title:this.state.points[this.state.activePoint].c?"Selected point: Curve to":"Selected point: Line to",id:"bg-nested-dropdown"},i.default.createElement(s.MenuItem,{eventKey:"0",onSelect:this.setPointType.bind(this,"L")},"Selected point: Line to"),i.default.createElement(s.MenuItem,{eventKey:"1",onSelect:this.setPointType.bind(this,"C")},"Selected point: Curve to")),0!==this.state.activePoint&&i.default.createElement(s.Button,{onClick:this.removeActivePoint.bind(this)},"Remove this point"),i.default.createElement(s.DropdownButton,{title:this.state.hasAnchor?"Route has anchor":"No anchor on route",disabled:0===this.state.points.length,id:"bg-nested-dropdown"},i.default.createElement(s.MenuItem,{eventKey:"0",onSelect:this.toggleAnchor.bind(this)},"No anchor on route"),i.default.createElement(s.MenuItem,{eventKey:"1",onSelect:this.toggleAnchor.bind(this)},"Route has anchor")),i.default.createElement(s.Button,{bsStyle:"warning",disabled:0===this.state.points.length,onClick:this.reset.bind(this)},"Reset path"),i.default.createElement(s.Button,{bsStyle:"danger",onClick:this.onCancel.bind(this)},"Cancel"),i.default.createElement(s.Button,{type:"submit",bsStyle:"success"},this.state.points.length>=2?"Save":"Delete path"))))),i.default.createElement(s.FormGroup,{controlId:"formControlsImage"},i.default.createElement("svg",{viewBox:"0 0 "+this.state.w+" "+this.state.h,onClick:this.addPoint.bind(this),onMouseMove:this.handleMouseMove.bind(this)},i.default.createElement("image",{ref:"buldreinfo-svg-edit-img",xlinkHref:u.default.getUrl("images?id="+this.state.mediaId),width:"100%",height:"100%"}),this.parseReadOnlySvgs(),i.default.createElement("path",{className:"buldreinfo-svg-route",d:n,strokeWidth:.002*this.state.w}),e)),i.default.createElement(s.FormGroup,{controlId:"formControlsPath"},n))))}}]),e}();e.default=g},79:function(t,e,n){"use strict";t.exports={getUrl:function(t){return"buldring.bergen-klatreklubb.no"==window.location.hostname?"https://buldring.bergen-klatreklubb.no/com.buldreinfo.jersey.jaxb/v1/"+t:"buldring.fredrikstadklatreklubb.org"==window.location.hostname?"https://buldring.fredrikstadklatreklubb.org/com.buldreinfo.jersey.jaxb/v1/"+t:"brattelinjer.no"==window.location.hostname?"https://brattelinjer.no/com.buldreinfo.jersey.jaxb/v1/"+t:"dev.jossi.org"==window.location.hostname?"https://dev.jossi.org/com.buldreinfo.jersey.jaxb/v1/"+t:"https://buldreinfo.com/com.buldreinfo.jersey.jaxb/v1/"+t},getTitle:function(){return"buldring.bergen-klatreklubb.no"==window.location.hostname?"Buldring i Hordaland":"buldring.fredrikstadklatreklubb.org"==window.location.hostname?"Buldring i Fredrikstad":"brattelinjer.no"==window.location.hostname?"Bratte linjer":"dev.jossi.org"==window.location.hostname?"Bratte linjer (dev)":"buldreinfo"},getRegion:function(){return"buldring.bergen-klatreklubb.no"==window.location.hostname?"2":"buldring.fredrikstadklatreklubb.org"==window.location.hostname?"3":"brattelinjer.no"==window.location.hostname?"4":"dev.jossi.org"==window.location.hostname?"4":"1"},getDefaultCenter:function(){return"buldring.bergen-klatreklubb.no"==window.location.hostname?{lat:60.47521,lng:6.83169}:"buldring.fredrikstadklatreklubb.org"==window.location.hostname?{lat:59.22844,lng:10.91722}:{lat:58.78119,lng:5.86361}},getDefaultZoom:function(){return"brattelinjer.no"==window.location.hostname?9:"dev.jossi.org"==window.location.hostname?9:7},convertFromDateToString:function(t){var e=t.getDate(),n=t.getMonth()+1;return t.getFullYear()+"-"+(n<=9?"0"+n:n)+"-"+(e<=9?"0"+e:e)}}},91:function(t,e,n){"use strict";n.r(e);var a=n(21);n.d(e,"MemoryRouter",function(){return a.a});var r=n(20);n.d(e,"Prompt",function(){return r.a});var i=n(16);n.d(e,"Redirect",function(){return i.a});var o=n(7);n.d(e,"Route",function(){return o.a});var s=n(6);n.d(e,"Router",function(){return s.a});var l=n(19);n.d(e,"StaticRouter",function(){return l.a});var u=n(18);n.d(e,"Switch",function(){return u.a});var d=n(5);n.d(e,"matchPath",function(){return d.a});var c=n(17);n.d(e,"withRouter",function(){return c.a})}}]);
//# sourceMappingURL=11.index.js.map